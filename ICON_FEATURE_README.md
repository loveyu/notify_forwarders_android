# 通知图标功能说明

本次更新为通知转发应用添加了通知图标支持功能。

## 新增功能

### 1. 通知图标设置选项
- 在设置页面新增"通知图标设置"卡片
- 提供开关控制是否发送通知图标
- 默认关闭，用户可手动开启

### 2. 图标缓存管理
- 自动获取应用图标并计算MD5值
- 本地缓存图标数据，缓存时间最长1天
- 每2小时自动清理过期缓存
- 应用启动时清空所有缓存
- 清空通知时同时清空图标缓存

### 3. 图标尺寸优化
- 自动选择120px以下的图标尺寸
- 支持多种图标格式的处理
- 转换为PNG格式并Base64编码

### 4. 智能推送机制
- 发送通知时包含图标MD5值
- 服务器返回`x-icon-status=miss`时异步推送完整图标信息
- 每个MD5值10分钟内仅推送一次，避免重复推送

### 5. 网络通信优化
- 通知接口新增`iconMd5`字段
- 新增图标推送接口`/api/icon`
- 推送内容包含：包名、应用名称、图标MD5、图标Base64数据、设备名称

### 6. 通知列表图标显示
- 在通知列表中显示应用图标
- 图标采用圆形裁剪，尺寸为48dp
- 优先从缓存加载图标，提升性能
- 异步加载图标，避免阻塞UI线程
- 加载失败时显示默认图标

## 技术实现

### 核心类
- `IconCacheManager`: 图标缓存管理器，负责图标获取、缓存、清理
- `ServerPreferences`: 新增图标开关设置的存储和获取
- `NotificationData`: 新增`iconMd5`字段
- `NotificationService`: 集成图标处理逻辑
- `AppIcon`: Compose组件，负责在UI中显示应用图标
- `NotificationItem`: 修改后的通知项组件，包含图标显示

### 缓存策略
- **内存缓存**: 使用ConcurrentHashMap存储图标数据
- **磁盘缓存**: 预留接口，可扩展持久化存储
- **推送限制**: 使用时间戳记录，防止频繁推送

### 性能优化
- 异步处理图标获取和推送
- 内存缓存优先，减少重复计算
- 定期清理过期数据，控制内存使用
- UI中异步加载图标，避免阻塞主线程
- 图标显示采用懒加载策略，仅在需要时获取

## 使用方法

### 用户操作
1. 打开应用设置页面
2. 找到"通知图标设置"卡片
3. 开启"发送通知图标"开关
4. 系统将自动处理后续的图标获取和推送
5. 在主界面通知列表中可以看到应用图标显示

### 服务器端配置
服务器需要支持以下接口：

#### 通知接口 `/api/notify`
请求中新增字段：
```json
{
  "appname": "应用名称",
  "title": "通知标题",
  "description": "通知内容",
  "devicename": "设备名称",
  "uniqueId": "唯一标识",
  "id": "通知ID",
  "iconMd5": "图标MD5值"
}
```

响应头：
```
x-icon-status: miss  // 当服务器没有该图标时返回
```

#### 图标推送接口 `/api/icon`
请求内容：
```json
{
  "packageName": "包名",
  "appName": "应用名称",
  "iconMd5": "图标MD5值",
  "iconBase64": "图标Base64数据",
  "devicename": "设备名称"
}
```

## 注意事项

1. **权限要求**: 需要应用具有通知监听权限
2. **存储空间**: 图标缓存会占用一定的存储空间
3. **网络流量**: 首次推送图标会产生额外的网络流量
4. **兼容性**: 与现有通知转发功能完全兼容，不影响原有功能

## 测试验证

项目包含单元测试验证核心功能：
- MD5计算的正确性和一致性
- 推送限制机制的有效性
- 缓存管理的基本功能

运行测试：
```bash
./gradlew test
```

## 版本信息

- 新增功能版本：基于当前代码库
- 兼容性：向后兼容，不影响现有功能
- 依赖：无新增外部依赖
